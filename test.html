<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="base-url" content="/">
    <title>Test - Registration Data Preloading</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-5">
        <h1>Test: Registration Data Preloading Logic</h1>
        <div id="alert-container"></div>
        
        <div class="row">
            <div class="col-md-6">
                <h3>RFC Search Test</h3>
                <div class="mb-3">
                    <label for="rfc" class="form-label">RFC</label>
                    <input type="text" class="form-control" id="rfc" placeholder="Ingrese RFC" data-event-slug="test-event">
                </div>
                <button onclick="testRFCSearch()" class="btn btn-primary">Test RFC Search</button>
            </div>
            
            <div class="col-md-6">
                <h3>Phone Search Test</h3>
                <div class="mb-3">
                    <label for="telefono" class="form-label">Teléfono</label>
                    <input type="tel" class="form-control" id="telefono" placeholder="Ingrese teléfono" data-event-slug="test-event">
                </div>
                <button onclick="testPhoneSearch()" class="btn btn-primary">Test Phone Search</button>
            </div>
        </div>
        
        <div class="row mt-4">
            <div class="col-md-6">
                <h3>Email Search Test</h3>
                <div class="mb-3">
                    <label for="email" class="form-label">Email</label>
                    <input type="email" class="form-control" id="email" placeholder="Ingrese email" data-event-slug="test-event">
                </div>
                <button onclick="testEmailSearch()" class="btn btn-primary">Test Email Search</button>
            </div>
            
            <div class="col-md-6">
                <h3>Test Form Fields</h3>
                <div class="mb-2">
                    <label class="form-label">Nombre Completo</label>
                    <input type="text" class="form-control" id="nombre_completo" readonly>
                </div>
                <div class="mb-2">
                    <label class="form-label">Razón Social</label>
                    <input type="text" class="form-control" id="razon_social" readonly>
                </div>
                <div class="mb-2">
                    <label class="form-label">Ocupación</label>
                    <input type="text" class="form-control" id="ocupacion" readonly>
                </div>
            </div>
        </div>
        
        <div class="row mt-4">
            <div class="col-12">
                <h4>Test Results</h4>
                <div id="test-results" class="alert alert-light">
                    <p>Test the search functions above. Expected behavior:</p>
                    <ul>
                        <li><strong>RFC Search:</strong> Should preload company + representative data</li>
                        <li><strong>Phone Search:</strong> Should ONLY preload guest data, suggest RFC for company data</li>
                        <li><strong>Email Search:</strong> Should ONLY preload guest data, suggest RFC for representative data</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="assets/js/app.js"></script>
    
    <script>
        // Mock API responses for testing
        const originalFetch = window.fetch;
        window.fetch = function(url, options) {
            // Mock different responses based on URL and input
            if (url.includes('buscar-empresa')) {
                const body = JSON.parse(options.body);
                const rfc = body.rfc;
                
                if (rfc === 'TEST123456ABC') {
                    return Promise.resolve({
                        json: () => Promise.resolve({
                            found: true,
                            empresa: {
                                razon_social: 'Test Company S.A.',
                                nombre_comercial: 'Test Company',
                                telefono_oficina: '4421234567',
                                direccion_fiscal: 'Test Address',
                                direccion_comercial: 'Test Commercial Address',
                                giro_comercial: 'Tecnología'
                            },
                            representante: {
                                nombre_completo: 'Juan Pérez',
                                email: 'juan@testcompany.com',
                                telefono: '4429876543',
                                puesto: 'Director General'
                            }
                        })
                    });
                } else {
                    return Promise.resolve({
                        json: () => Promise.resolve({ found: false })
                    });
                }
            }
            
            if (url.includes('buscar-por-telefono')) {
                const body = JSON.parse(options.body);
                const telefono = body.telefono;
                
                if (telefono === '4421111111') {
                    // Simulate guest data found
                    return Promise.resolve({
                        json: () => Promise.resolve({
                            found: true,
                            tipo: 'invitado',
                            data: {
                                nombre_completo: 'María García',
                                email: 'maria@email.com',
                                ocupacion: 'Contador',
                                cargo_gubernamental: null
                            }
                        })
                    });
                } else if (telefono === '4422222222') {
                    // Simulate representative data found
                    return Promise.resolve({
                        json: () => Promise.resolve({
                            found: true,
                            tipo: 'representante',
                            data: {
                                nombre_completo: 'Carlos López',
                                email: 'carlos@company.com',
                                rfc: 'COMPANY123456',
                                razon_social: 'Company S.A.'
                            }
                        })
                    });
                } else {
                    return Promise.resolve({
                        json: () => Promise.resolve({ found: false })
                    });
                }
            }
            
            if (url.includes('buscar-por-email')) {
                const body = JSON.parse(options.body);
                const email = body.email;
                
                if (email === 'guest@email.com') {
                    // Simulate guest data found
                    return Promise.resolve({
                        json: () => Promise.resolve({
                            found: true,
                            tipo: 'invitado',
                            data: {
                                nombre_completo: 'Ana Martínez',
                                telefono: '4423333333',
                                ocupacion: 'Designer',
                                cargo_gubernamental: null
                            }
                        })
                    });
                } else if (email === 'rep@company.com') {
                    // Simulate representative data found
                    return Promise.resolve({
                        json: () => Promise.resolve({
                            found: true,
                            tipo: 'representante',
                            data: {
                                nombre_completo: 'Luis Torres',
                                telefono: '4424444444',
                                rfc: 'TORRES123456',
                                razon_social: 'Torres S.A.'
                            }
                        })
                    });
                } else {
                    return Promise.resolve({
                        json: () => Promise.resolve({ found: false })
                    });
                }
            }
            
            // Default to original fetch for other URLs
            return originalFetch.apply(this, arguments);
        };
        
        function testRFCSearch() {
            const rfcInput = document.getElementById('rfc');
            const testValue = rfcInput.value || 'TEST123456ABC';
            rfcInput.value = testValue;
            CANACO.registration.searchByRFC(testValue, 'test-event');
            logTest('RFC Search', testValue);
        }
        
        function testPhoneSearch() {
            const phoneInput = document.getElementById('telefono');
            const testValue = phoneInput.value || '4421111111'; // Default to guest data
            phoneInput.value = testValue;
            CANACO.registration.searchByPhone(testValue, 'test-event');
            logTest('Phone Search', testValue);
        }
        
        function testEmailSearch() {
            const emailInput = document.getElementById('email');
            const testValue = emailInput.value || 'guest@email.com'; // Default to guest data
            emailInput.value = testValue;
            CANACO.registration.searchByEmail(testValue, 'test-event');
            logTest('Email Search', testValue);
        }
        
        function logTest(type, value) {
            const results = document.getElementById('test-results');
            const time = new Date().toLocaleTimeString();
            results.innerHTML += `<div class="border-top pt-2 mt-2"><small class="text-muted">[${time}]</small> <strong>${type}</strong> with value: <code>${value}</code></div>`;
        }
        
        // Test values info
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('test-results').innerHTML += `
                <div class="mt-3">
                    <h6>Test Values:</h6>
                    <ul class="small">
                        <li><strong>RFC:</strong> TEST123456ABC (company data) | Any other (not found)</li>
                        <li><strong>Phone:</strong> 4421111111 (guest data) | 4422222222 (rep data) | Any other (not found)</li>
                        <li><strong>Email:</strong> guest@email.com (guest data) | rep@company.com (rep data) | Any other (not found)</li>
                    </ul>
                </div>
            `;
        });
    </script>
</body>
</html>